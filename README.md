# Art Gallery Backend

Этот проект разработан для управления цифровым контентом, профилями пользователей и взаимодействием с артами, таким как просмотры, лайки и комментарии.

## О проекте

Бэкенд **Art Gallery** разработан с использованием **Spring Boot** и предоставляет **RESTful API** для взаимодействия с клиентским приложением. Он включает кэширование данных, обработки изображений, интеграции с внешними сервисами и безопасную аутентификацию.

### Ключевые особенности
- **Управление артами**: Загрузка, просмотр, обновление и удаление артов.
- **Тегирование артов**: Автоматическое и ручное добавление тегов для категоризации и поиска.
- **Взаимодействие с пользователями**: Лайки, просмотры и комментарии к артам.
- **Профили пользователей**: Регистрация, обновление профиля, управление социальными сетями и подписками.
- **Система рекомендаций**: Ленты артов, включая трендовые, рекомендованные и подписки.
- **Поиск**: Поиск артов по названию и тегам.
- **Надежное хранение**: Использование S3-совместимого хранилища для медиафайлов.
- **Кэширование**: Использование Redis для повышения производительности API.
- **Безопасность**: Аутентификация и авторизация на основе Keycloak.

## Технологии

Проект построен на следующих основных технологиях:

- **Spring Boot 3**
    - **Spring Web**: Для создания RESTful API.
    - **Spring Data JPA**: Для работы с базой данных (PostgreSQL).
    - **Spring Security**: Для обеспечения безопасности и интеграции с Keycloak.
    - **Spring Cache**: Для кэширования данных с Redis.
- **PostgreSQL**: Основная база данных для хранения данных о пользователях, артах, комментариях и т.д.
- **Keycloak**: Сервер аутентификации и авторизации (IdP).
- **Redis**: Распределенное кэширование для ускорения работы приложения.
- **MinIO (S3-совместимое хранилище)**: Для хранения изображений артов и аватаров пользователей.
- **WebClient (Spring WebFlux)**: Для взаимодействия с внешним API нейронной сети.
- **ModelMapper**: Для преобразования DTO в сущности и обратно.


## Настройка и запуск
1. **Настройка окружения** (`application.properties`):

    - Убедитесь, что ваш файл `src/main/resources/application.properties` настроен правильно. 
    - Также убедитесь, что ваш файл `docker-compose.yml` настроен правильно.


2. **Запуск вспомогательных сервисов с Docker Compose**:

   Перейдите в корневую директорию проекта, где находится файл `docker-compose.yml`, и запустите сервисы:

   ```bash
   docker-compose up -d
   ```

   Это запустит **Keycloak**, **MinIO** и **Redis**.

3. **Настройка MinIO**:

   После запуска MinIO выполните следующие команды для настройки бакета `arts-photo` и установки публичного доступа:

   ```bash
   docker exec -it minio /usr/bin/mc alias set myminio http://localhost:9000 minioadmin minioadmin
   docker exec -it minio /usr/bin/mc mb myminio/arts-photo
   docker exec -it minio /usr/bin/mc policy set public myminio/arts-photo
   docker exec -it minio /usr/bin/mc anonymous set public myminio/arts-photo
   ```

   **Важно**: Убедитесь, что база данных `arts` создана в вашем PostgreSQL, прежде чем запускать Spring Boot приложение. Вы можете создать её вручную или использовать инструмент управления базами данных.


   Приложение должно запуститься на порту **8081** (или другом, указанном в `application.properties`).

## Аутентификация (Keycloak)

Для работы с API, требующими аутентификации, необходимо зарегистрироваться в **Keycloak** и получить токен доступа.

### Настройка Keycloak Realm

Сервис `keycloak` в `docker-compose.yml` настроит Keycloak с realm `arts-realm` и администратором `admin/admin`. Вы можете получить доступ к панели администратора Keycloak по адресу: [http://localhost:8080/admin/](http://localhost:8080/admin/).

### Процесс регистрации и логина

1. **Регистрация в Keycloak**:

   ```
   POST http://localhost:8081/keycloak/register
   ```

   **Тело запроса**: JSON с `username`, `email`, `password`.  
   **Ответ**: `id` пользователя в Keycloak.

2. **Регистрация пользователя в приложении** (связывание с Keycloak ID):

   ```
   POST http://localhost:8081/users/register
   ```

   **Тело запроса**: JSON с `id` (полученным от Keycloak) и `userName`.

3. **Получение JWT-токена (логин)**:

   ```
   POST http://localhost:8080/realms/arts-realm/protocol/openid-connect/token
   ```

   **Тело запроса**: Form Data с `grant_type=password`, `client_id=backend-client`, `username={ваш_username}`, `password={ваш_password}`.  
   **Ответ**: JWT-токен, который нужно использовать в заголовке `Authorization: Bearer <токен>` для защищенных запросов.

## API Endpoints

Ниже представлен обзор основных API эндпоинтов, сгруппированных по функционалу.

### Страница работы (Арта)

- **GET** `/arts/with-author/{id}`: Получить детальную информацию об арте по его ID, включая автора.
- **GET** `/tags/art?id={artId}`: Получить список тегов для указанного арта.
- **GET** `/comments/art?id={artId}&page={page}&size={size}`: Получить список комментариев к арту с пагинацией.
- **GET** `/users/subscribe?id={authorId}`: Проверить, подписан ли текущий пользователь на автора данного арта.
- **GET** `/arts/like?id={artId}`: Проверить, поставил ли текущий пользователь лайк на этот арт.
- **POST** `/users/subscribe?id={authorId}`: Подписаться или отписаться от автора арта.
- **POST** `/arts/like?id={artId}`: Поставить лайк на арт.
- **POST** `/comments/art`: Добавить новый комментарий к арту.

### Страница автора

- **GET** `/users?id={userId}`: Получить детальную информацию о пользователе (авторе) по его ID.
- **GET** `/users/subscribe?id={authorId}`: Проверить, подписан ли текущий пользователь на данного автора.
- **GET** `/users/arts?id={userId}&page={page}&size={size}`: Получить список карточек артов, созданных данным автором, с пагинацией.
- **GET** `/users/social-networks?id={userId}`: Получить ссылки на социальные сети автора.
- **POST** `/users/subscribe?id={authorId}`: Подписаться или отписаться от автора.

### Страница подписок пользователя

- **GET** `/users/subs-with-arts?page={page}&size={size}`: Получить список авторов, на которых подписан текущий пользователь, с их последними артами.
- **GET** `/users/subscribe?id={authorId}`: Проверить статус подписки на конкретного автора (используется внутри списка).
- **POST** `/users/subscribe?id={authorId}`: Управлять подпиской на автора.

### Страница лайков

- **GET** `/arts/likes?page={page}&size={size}`: Получить список артов, лайкнутых текущим пользователем, с пагинацией.

### Главная страница

- **GET** `/arts/feed?type={latest|trending|recommended|subscriptions}&page={page}&size={size}`: Получить ленту артов, отсортированных по различным критериям (последние, трендовые, рекомендованные, подписки), с пагинацией.

### Общие элементы и утилиты

- **GET** `/users/get-recent-sub?limit={limit}`: Получить список последних подписок текущего пользователя для отображения в боковой панели.
- **GET** `/users/me/min`: Получить минимальную информацию о текущем авторизованном пользователе (для отображения в хедере).
- **GET** `/arts/search?query={query}&page={page}&size={size}`: Поиск артов по названию и тегам (для поисковой строки).

### Редактирование профиля пользователя

- **PUT** `/users/me`: Обновить профиль текущего пользователя. Принимает `multipart/form-data` для загрузки аватара и JSON для других полей (`userName`, `description`, `socialNetwork`).

### Публикация работы

- **POST** `/arts`: Загрузить новый арт. Требует `multipart/form-data`, содержащий файл изображения (`imageFile`), название (`name`), описание (`description`), статус NSFW (`nsfw`), и список тегов (`tags`).

### Редактирование работы

- **PUT** `/arts`: Обновить информацию о существующем арте. Требует `multipart/form-data`. Можно обновить изображение, название, описание и теги.

## Безопасность

Приложение использует **Spring Security** с **OAuth2 Resource Server** для обработки JWT-токенов, выпущенных Keycloak.

- **Аутентификация**: Пользователи аутентифицируются через Keycloak. После успешной аутентификации Keycloak выдает JWT, который используется для доступа к защищенным эндпоинтам.
- **Авторизация**: Разрешения основаны на ролях, содержащихся в JWT. Приложение настроено для проверки ролей (`ROLE_` префикс), определенных в Keycloak.

## Кэширование (Redis)

Для повышения производительности, особенно для часто запрашиваемых данных, используется **Redis**.

- Кэширование включено с помощью `@EnableCaching` и управляется аннотациями `@Cacheable`, `@CacheEvict`, `@CachePut`.
- Конфигурация кэша (`RedisConfig`) настроена для различных типов данных (арты, комментарии, теги, пользователи) с разными TTL (Time-To-Live).

## Хранение файлов (MinIO / S3)

Изображения артов и аватаров пользователей хранятся в S3-совместимом хранилище (**MinIO**).

- Файлы загружаются непосредственно в MinIO через **AWS S3 SDK**.
- Ссылки на файлы хранятся в базе данных.
- Публичный доступ к бакету `arts-photo` настроен для прямого доступа к изображениям.

## Интеграция с AI API

Для автоматического извлечения тегов из изображений проект интегрирован с внешним API нейронной сети.

- API вызывается при загрузке нового арта.
- Полученные теги добавляются к арту вместе с тегами, предоставленными пользователем.
